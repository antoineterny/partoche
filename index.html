<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Lecteur de partoche</title>
        <link href="normalize.css" rel="stylesheet" type="text/css">
        <style>
            @import url('https://fonts.googleapis.com/css2?family=IM+Fell+DW+Pica&display=swap');
            body {
                font-family: 'IM Fell DW Pica', serif;
                background-color: #feffef;
            }
            h1 {
                text-align: center;
                text-transform: uppercase;
            }
            .conteneur {
                max-width: 1200px;
                margin: auto;
                filter: sepia(1);
            }
            .partoche-viewer {
                max-width: 1200px;
                height: 400px;
                /* border: 1px solid black; */
                position: relative;
                margin-bottom: 1em;
            }
            .partoche-viewer img {
                top: 50%;                         
                position: absolute;               
                transform: translate(0, -50%) }
            .audio-control {
                display: flex;
            }
            .audio-control button {
                width: 30px;
                height: 30px;
                border: none;
                padding: 0;
                vertical-align: middle;
                text-indent: -9999px; 
                margin-right: 2px;
                flex-grow: 0;
            }
            .play-button {
                background: url(img/playB.svg);
            }
            .play-button:hover {
                background: url(img/playW.svg);
            }
            .pause-button {
                background: url(img/pauseB.svg);
            }
            .pause-button:hover {
                background: url(img/pauseW.svg);
            }
            .stop-button {
                background: url(img/stopB.svg);
            }
            .stop-button:hover {
                background: url(img/stopW.svg);
            }
            #progressBarControl {
                height: 30px;
                flex-grow: 50;
            }
            #progressBar {
                color: #feffef;
                background-color: black ;
                height: 30px;
                font-size: 24px;
                vertical-align: middle;
                line-height: 30px;
                flex-grow: 50;
            }
        </style>
    </head>
    <body>
        <div class="conteneur">
            <h1>Chopin - Prélude Op. 28, No.10</h1>
            <div class="partoche-viewer">
                <img id="partoche" src="prelude10/slice1.png" style="width: 100%;">
            </div>

            <div class="audio-control">
                <audio id='lecteurAudio1' src='prelude10/prelude10.mp3' ontimeupdate="update(this)"></audio>
                <button class='control play-button' id="button1" onclick='play("lecteurAudio1", this)'>Lecture</button>
                <button class='control stop-button' id="button2" onclick='stop("lecteurAudio1", this)'>Arrêt</button>
                <div id="progressBarControl">
                    <div id="progressBar">&nbsp;00:00</div>
                </div>
            </div>
        </div>
        <script>
            let markers = ['0:00.000'];
            async function main() {
                let markersRaw = await fetch('prelude10/prelude10 reaper_regions_markers.csv')
                    .then(response => { return response.text() })
                markersRaw = markersRaw.split(",");
                markersRaw = markersRaw.slice(6);
                let nbMarkers = Math.ceil(markersRaw.length/4);
                for (let i=0; i<nbMarkers; i++) {
                    markers.push(markersRaw[i*4])
                }
                for (let i=0; i<markers.length; i++) {
                    markers[i] = Number(markers[i].slice(2))
                }
                markers.push(999999)
                console.log(markers)
            }
            main();

            function play(idPlayer, playBtn) {
                let player = document.querySelector('#' + idPlayer);
                if (player.paused) {
                    player.play();
                    playBtn.classList.remove("play-button");
                    playBtn.classList.add("pause-button");
                } else {
                    player.pause();
                    playBtn.classList.remove("pause-button");
                    playBtn.classList.add("play-button");
                }
            }
            function stop(idPlayer) {
                let player = document.querySelector('#' + idPlayer);
                player.currentTime = 0;
                player.pause();
                let playBtn = document.querySelector("#button1");
                playBtn.classList.remove("pause-button");
                playBtn.classList.add("play-button");
            }
            function update(player) {
                var duration = player.duration;    // Durée totale
                var time     = player.currentTime; // Temps écoulé
                var fraction = time / duration;
                var percent  = Math.ceil(fraction * 100);
                var progress = document.querySelector('#progressBar');
                let partoche = document.querySelector("#partoche");

                progress.style.width = percent + '%';
                document.querySelector('#progressBar').innerHTML = "&nbsp;" + formatTime(time);

                for (let i=0; i<markers.length; i++) {
                    if (time > markers[i] && time < markers[i+1]) {
                        partoche.src = "prelude10/slice" + (i+1) + ".png"
                    }
                }

            }
            function formatTime(time) {
                var hours = Math.floor(time / 3600);
                var mins  = Math.floor((time % 3600) / 60);
                var secs  = Math.floor(time % 60);
                if (secs < 10) {
                    secs = "0" + secs;
                }
                if (hours) {
                    if (mins < 10) {
                        mins = "0" + mins;
                    }
                    return hours + ":" + mins + ":" + secs; // hh:mm:ss
                } else {
                    return mins + ":" + secs; // mm:ss
                }
            }
            function getMousePosition(event) {
                return {
                    x: event.pageX,
                    y: event.pageY
                }
            }

        </script>
    </body>
</html>